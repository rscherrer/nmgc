#' Plot a confusion matrix
#'
#' Custom function to plot the results of a classification analysis across multiple machines
#'
#' @param data A data frame with the frequency of assignments for each predicted and true groups (confusion matrix in the long format). There must be at least columns "true", "predicted" and "freq".
#' @param color Color of the high frequency tiles
#' @param xlab Optional x-label
#' @param ylab Optional y-label
#' @param facets Variable giving the facets to split by. Defaults to NULL, i.e. no facets
#' @param void Whether to get rid of all labels and legend (useful when plotting as an inset plot)
#'
#' @return A (facetted) confusion matrix plot
#'
#' @export

plot_confusion_matrix <- function(data, color = "darkgreen", xlab = "True", ylab = "Predicted", facets = NULL, void = FALSE) {

  library(tidyverse)

  p <- ggplot(data) +
    geom_tile(aes(x = true, y = predicted, fill = freq)) +
    theme_bw() +
    scale_fill_gradient(low = "white", high = color, limits = c(0, 1)) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    labs(fill = "Frequency") +
    xlab(xlab) +
    ylab(ylab)

  if (!is.null(facets)) p <- p + facet_wrap(. ~ get(facets))

  if (void) {

    # Remove labels and legends if needed (useful when plotting as an inset plot)
    p <- p + scale_x_discrete(breaks = NULL) +
      scale_y_discrete(breaks = NULL) +
      xlab(NULL) +
      ylab(NULL) +
      theme(legend.position = "none")

  }

  return (p)

}
